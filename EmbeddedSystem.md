# 嵌入式工程师知识要点总结

在跟进新项目的时候，发现自己在嵌入式方面的一些基础知识很是欠缺，结合TP同事给出的建议，应该及时做好笔记，“沉淀”，以避免陷入局限。

---
## 1. U-Boot

U-Boot的主要作用就是来启动Linux内核的。因为CPU不能直接从块设备中执行代码，因此需要把块设备中的代码复制到内存中，复制之前需要很多初始化的准备工作，比如时钟，串口等。

如果想让CPU启动内核，则需要通过其他程序，进行必要的初始化工作，然后将内核拷贝到内存中，并进行这块代码的初始化，从而启动Linux内核。一般情况下Linux内核会被存放在SD卡、iNand、NandFlash中，首先执行U-Boot代码，然后U-Boot将内核代码复制到地址为0x30008000地址处，然后再执行bootm 0x30008000。

1. Universal Boot Loader的简称，系统上电后第一段运行的程序

2. 主要作用是系统引导，从FLASH从引导压缩/非压缩的系统内核

3. 支持Linux/netBSD/VxWorks/QNX等嵌入式系统内核

4. 开源，可配置，支持多设备驱动，支持多种处理器等优点

5. 工作模式有2种：

   + 启动加载模式

     默认工作模式，BootLoader将嵌入式操作系统从FLASH加载到SDRAM中运行，整个过程是自动

   + 下载模式

     通过某些通信手段将内核镜像或者根文件系统镜像从PC机中下载/烧录到目标板的FLASH中

6. 启动过程

   + 大部分的BootLoader的启动过程都分为stage1和stage2两个部分，U-Boot也是

   + 依赖于CPU体系结构的代码（初始化硬件设备的代码）通常放在stage1中，用汇编语言写的

   + stage2通常用C语言写，这样方便实现复杂的功能，同时也拥有较好的可移植性

     ### 6.1 stage1

     通常放在start.S文件中，汇编写成。

     1. 定义入口，一个可执行的image必须有一个入口点，并且有且只能有一个全局入口，通常放在ROM（FLASH）的0x0地址。因此，必须告知编译器，使其知道这个入口，这个工作可以通过修改链接器来完成。
     2. 设置异常向量（exception vector）
     3. 设置CPU的速度、时钟频率和中断控制器
     4. 初始化内存控制器
     5. 将ROM中的程序复制到RAM中
     6. 初始化堆栈
     7. 转到RAM中执行，该工作可使用指令ldrpc来完成

     ### 6.2 stage2

     lib_arm/board.c中的start_armboot是C语言开始的地方，也是整个启动过程中C语言的主函数，同时也是整个uboot的主函数

     1. 调用一系列初始化函数
     2. 初始化FLASH设备
     3. 初始化系统内存分配函数
     4. 如果目标系统用NAND设备，则初始化NAND设备
     5. 如果有显示设备，则初始化该类设备
     6. 初始化相关网络设备，填写IP、C地址等
     7. 进入命令循环（即整个U-Boot的工作循环），接受用户下发的串口命令

7. 升级U-Boot的方式：

   + bubt从tftp服务器升级

     搭建tftp服务器，将对应的uboot.bin放到tftp服务器上，在目标板uboot下执行bubut uboot.bin，执行完成后进升级成新的uboot

   + 串口升级

## 2. Kernel

操作系统内核，通常管理存储器、文件、外设和系统资源等。操作系统内核通常运行进程，并提供进程间通信。从定义上和Shell相对。

功能上：

- 事件的调度和同步
- 进程管理
- 进程间通信
- 存储器管理

## 3. File System

文件系统是操作系统用于明确在存储设备上组织文件的方式。操作系统中负责管理和存储文件信息的软件机构，成为文件管理系统，简称文件系统。

由三个部分组成：

i.  文件系统的接口

ii. 对对象操作和管理的软件集合

iii. 对象及属性

从系统的角度来说，文件系统是对文件存储设备的空间进行组织和分配，负责文件存储并对存入的文件进行检索和保护的系统。具体而言，负责为用户建立文件，存入、读出、删除、转存文件，控制文件的读取，并在用户不需要时，撤销文件等。

一个分区/磁盘作为文件系统使用前，需要初始化，并将记录数据写到磁盘上，该过程称为建立文件系统。

Unix文件系统有类似的数据结构：

+ super block：存储总体信息，例如大小等
+ i node：除文件名以外的所有信息
+ data block
+ directory block
+ indirection block

常用的文件系统:

| 文件系统 |         操作系统         | 最小扇区  | 最大扇区 |        最大单一文件        |          最大格式化容量           |     档案数量     |
| :------: | :----------------------: | :-------: | :------: | :------------------------: | :-------------------------------: | :--------------: |
|  FAT32   |      Win 95 OSR2后       | 512 bytes |   64KB   | 2TB(NT内核系统限制为32GB） |                2TB                |     4194304      |
|   NTFS   |        Win 2000后        | 512 bytes |   64KB   |   2TB~256TB（受MBR影响）   |      2TB~256TB（受MBR影响）       |        无        |
|  exFAT   | Win CE 6/Vista SP1/Win 8 | 512 bytes | 32768KB  |       16EB（理论值）       | 16EB（理论值）（目前支持到256TB） | 至少可以大于1000 |

## 4. U-Boot、Kernel、File System三者的关系

网上看到一幅比较简介的图：

## 5. FLASH划分

开发板的datasheet都有详细的地址划分，主要分以下两块：

+ DDR地址空间：系统和应用的运行空间，通常有Linux系统进行管理和使用

+ FLASH地址空间：是系统和应用的存放空间，需要在使用前划分，用应用开发者管理。

  布局通常需要做的有：

  1. 确定U-Boot二进制文件的大小，使用的地址范围

  2. 确定Linux Kernel镜像文件的大小，使用的地址范围

  3. 确定rootfs 根文件系统的镜像文件大小，使用的地址范围

  4. 估算整个方案需要的空间大小和地址范围

     举例如下：

     Flash的整体地址空间为：0x34000000~0x34FFFFFF，共16MB,使用的是Nor Flash芯片。

     项目的布局如下：

     uboot：0x34000000 \~ 0x34080000, 512 KB
     
     kernel : 0x34080000 \~ 0x34180000, 1 MB, 文件大小为952.8 KB
     
rootfs : 0x34180000 \~ 0x34700000, 5.5 MB, 文件大小为3.85 MB
     
     app : 0x34700000 \~ 0x34FFFFFF, 9 MB, 文件大小为3.725 MB

## Unix系统启动流程

https://www.runoob.com/linux/linux-system-boot.html

## 工具