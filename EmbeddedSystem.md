# 嵌入式工程师知识要点总结

在跟进新项目的时候，发现自己在嵌入式方面的一些基础知识很是欠缺，结合TP同事给出的建议，应该及时做好笔记，“沉淀”，以避免陷入局限。

---
## 1. U-Boot

1. Universal Boot Loader的简称，系统上电后第一段运行的程序

2. 主要作用是系统引导，从FLASH从引导压缩/非压缩的系统内核

3. 支持Linux/netBSD/VxWorks/QNX等嵌入式系统内核

4. 开源，可配置，支持多设备驱动，支持多种处理器等优点

5. 综上，U-Boot的主要作用就是来启动Linux内核的。因为CPU不能直接从块设备中执行代码，因此需要把块设备中的代码复制到内存中，复制之前需要很多初始化的准备工作，比如时钟，串口等。

6. 工作模式有2种：

   + 启动加载模式

     默认工作模式，BootLoader将嵌入式操作系统从FLASH加载到SDRAM中运行，整个过程是自动

   + 下载模式

     通过某些通信手段将内核镜像或者根文件系统镜像从PC机中下载/烧录到目标板的FLASH中

7. 启动过程

   + 大部分的BootLoader的启动过程都分为stage1和stage2两个部分，U-Boot也是

   + 依赖于CPU体系结构的代码（初始化硬件设备的代码）通常放在stage1中，用汇编语言写的

   + stage2通常用C语言写，这样方便实现复杂的功能，同时也拥有较好的可移植性

     ### 6.1 stage1

     通常放在start.S文件中，汇编写成。

     1. 定义入口，一个可执行的image必须有一个入口点，并且有且只能有一个全局入口，通常放在ROM（FLASH）的0x0地址。因此，必须告知编译器，使其知道这个入口，这个工作可以通过修改链接器来完成。
     2. 设置异常向量（exception vector）
     3. 设置CPU的速度、时钟频率和中断控制器
     4. 初始化内存控制器
     5. 将ROM中的程序复制到RAM中
     6. 初始化堆栈
     7. 转到RAM中执行，该工作可使用指令ldrpc来完成

     ### 6.2 stage2

     lib_arm/board.c中的start_armboot是C语言开始的地方，也是整个启动过程中C语言的主函数，同时也是整个uboot的主函数

     1. 调用一系列初始化函数
     2. 初始化FLASH设备
     3. 初始化系统内存分配函数
     4. 如果目标系统用NAND设备，则初始化NAND设备
     5. 如果有显示设备，则初始化该类设备
     6. 初始化相关网络设备，填写IP，C地址等
     7. 进入命令循环（即整个U-Boot的工作循环），接受用户下发的串口命令

8. 升级U-Boot的方式：

   + bubt从tftp服务器升级

     搭建tftp服务器，将对应的uboot.bin放到tftp服务器上，在目标板uboot下执行bubut uboot.bin，执行完成后进升级成新的uboot

   + 串口升级

## 2. Kernel

操作系统内核，通常管理存储器、文件、外设和系统资源等。操作系统内核通常运行进程，并提供进程间通信。

从定义上和Shell相对。

## 3. File System

## 4. U-Boot、Kernel、File System三者的关系

## 5. FLASH划分

开发板的datasheet都有详细的地址划分，主要分以下两块：

+ DDR地址空间：系统和应用的运行空间，通常有Linux系统进行管理和使用

+ FLASH地址空间：是系统和应用的存放空间，需要在使用前划分，用应用开发者管理。

  布局通常需要做的有：

  1. 确定U-Boot二进制文件的大小，使用的地址范围

  2. 确定Linux Kernel镜像文件的大小，使用的地址范围

  3. 确定rootfs 根文件系统的镜像文件大小，使用的地址范围

  4. 估算整个方案需要的空间大小和地址范围

     举例如下：

     Flash的整体地址空间为：0x34000000~0x34FFFFFF,共16MB,使用的是Nor Flash芯片。

     项目的布局如下：

     uboot：0x34000000~0x34080000, 512KB
     kernel : 0x34080000~0x34180000, 1MB, 文件大小为952.8KB
     rootfs : 0x34180000~0x34700000, 5.5MB, 文件大小为3.85MB
     app : 0x34700000~0x34FFFFFF, 9MB, 文件大小为3.725MB

     

